# Mitigação Manual da CVE-2024-38819

Este guia apresenta os passos para mitigar a vulnerabilidade **CVE-2024-38819** em aplicações que utilizam o Spring Framework sem a necessidade de atualizar para versões corrigidas. A vulnerabilidade permite ataques de **path traversal**, onde invasores podem acessar arquivos não autorizados no sistema.

---

## 1. Entenda o Problema

A vulnerabilidade ocorre quando um invasor utiliza caracteres como `../` para navegar fora do diretório permitido de arquivos estáticos, comprometendo a segurança do sistema.

---

## 2. Adicione Verificações de Segurança

Antes de servir arquivos estáticos, valide se o caminho solicitado está dentro de um diretório permitido.

### Exemplo em Java:
```java
import java.nio.file.Path;
import java.nio.file.Paths;

public class FileSecurityUtil {

    public static boolean isPathSecure(String basePath, String requestedPath) {
        try {
            // Converte os caminhos para objetos Path
            Path base = Paths.get(basePath).toRealPath();
            Path requested = Paths.get(basePath, requestedPath).toRealPath();

            // Verifica se o caminho solicitado está dentro do diretório base
            return requested.startsWith(base);
        } catch (Exception e) {
            // Em caso de erro (path inválido ou não encontrado), negar acesso
            return false;
        }
    }
}
```
---

## 3. Integre no Controller

No controlador responsável por servir arquivos estáticos, utilize a função de validação criada anteriormente para garantir que o acesso é seguro.

### Exemplo com Spring WebMvc.fn:
```java
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class StaticFileController {

    private final String basePath = "/path/to/allowed/directory";
    private final ResourceLoader resourceLoader;

    public StaticFileController(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    @GetMapping("/files")
    public ResponseEntity<?> serveFile(@RequestParam String fileName) {
        if (!FileSecurityUtil.isPathSecure(basePath, fileName)) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body("Access Denied");
        }

        Resource file = resourceLoader.getResource("file:" + basePath + "/" + fileName);
        if (!file.exists()) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body("File not found");
        }

        return ResponseEntity.ok(file);
    }
}
```

---

## 4. Sanitizar a Entrada

Antes de processar o nome do arquivo, sanitize-o para remover caracteres suspeitos como `../` ou outros que possam comprometer a segurança.

### Exemplo:
```java
public static String sanitizeFileName(String fileName) {
    return fileName.replaceAll("[^a-zA-Z0-9._-]", "_");
}
```

---

## 5. Teste a Aplicação

Realize testes rigorosos para garantir que as alterações foram eficazes:

- Simule ataques enviando requisições maliciosas contendo caracteres como `../` ou caminhos absolutos.
- Garanta que apenas arquivos dentro do diretório permitido sejam acessíveis.
- Verifique se os arquivos legítimos são servidos corretamente após a implementação das validações.

---

## 6. Monitore

Implemente medidas de monitoramento para identificar tentativas de exploração:

- Configure logs para registrar tentativas de acesso a caminhos não permitidos.
- Implemente alertas para identificar possíveis ataques de exploração.
- Analise os logs regularmente para detectar padrões de tentativas de exploração e agir rapidamente.

---

